<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Affitti 2025</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      margin: 20px;
      font-size: 1.5rem;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }

    .controls button {
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      background-color: #e9ecef;
      cursor: pointer;
      border-radius: 6px;
    }

    .calendar {
      width: 100%;
      max-width: 600px;
    }

    .month-title {
      text-align: center;
      background-color: #fff3cd;
      font-weight: bold;
      padding: 10px;
      margin-top: 10px;
      font-size: 1.2rem;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: #dee2e6;
      font-weight: bold;
      text-align: center;
      padding: 10px 0;
    }

    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }

    .day {
      height: 60px;
      border: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      padding: 5px;
      box-sizing: border-box;
      background-color: #f1f3f5;
      position: relative;
    }

    .day.occupied {
      background-color: #f8d7da !important;
    }

    .day.weekend {
      background-color: #e7f1ff;
    }

    .price {
      font-size: 10px;
      color: #555;
    }

    .tooltip {
      position: absolute;
      top: 2px;
      left: 2px;
      font-size: 10px;
      font-weight: bold;
      background: rgba(255,255,255,0.8);
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Calendario Affitti 2025</h1>
  <div class="controls">
    <button onclick="prevMonth()">‚¨ÖÔ∏è Mese precedente</button>
    <button onclick="nextMonth()">‚û°Ô∏è Mese successivo</button>
    <button onclick="goToToday()">üìÖ Torna a oggi</button>
  </div>
  <div id="calendar" class="calendar"></div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbyUBbLjZoycZJDnRM4xb3lrrVPAVMt6VrJsnJYy12Xfm2Qb3MEZmOdJjcJHmTmYF2fs0Q/exec";

    const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
    const dayNames = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    function fetchData() {
      return fetch(scriptUrl)
        .then(res => res.json());
    }

    function isOccupied(dateStr, prenotazioni) {
      const current = new Date(dateStr);
      for (const pren of prenotazioni) {
        const start = new Date(pren.start);
        const end = new Date(pren.end);
        if (current >= start && current < end) return pren.nome;
      }
      return null;
    }

    function buildCalendar(prenotazioni, prezzi) {
      const container = document.getElementById("calendar");
      container.innerHTML = "";
      const monthTitle = document.createElement("div");
      monthTitle.className = "month-title";
      monthTitle.textContent = `${monthNames[currentMonth].toUpperCase()} ${currentYear}`;
      container.appendChild(monthTitle);

      const weekdayRow = document.createElement("div");
      weekdayRow.className = "weekdays";
      dayNames.forEach(d => {
        const dayEl = document.createElement("div");
        dayEl.textContent = d;
        weekdayRow.appendChild(dayEl);
      });
      container.appendChild(weekdayRow);

      const daysGrid = document.createElement("div");
      daysGrid.className = "days";

      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      for (let i = 1; i < (firstDay === 0 ? 7 : firstDay); i++) {
        daysGrid.appendChild(document.createElement("div"));
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const cell = document.createElement("div");
        cell.className = "day";

        const giornoSettimana = new Date(dateStr).getDay();
        if (giornoSettimana === 0 || giornoSettimana === 6) cell.classList.add("weekend");

        const occupatoDa = isOccupied(dateStr, prenotazioni);
        if (occupatoDa) {
          cell.classList.add("occupied");
          const tooltip = document.createElement("div");
          tooltip.className = "tooltip";
          tooltip.textContent = occupatoDa;
          cell.appendChild(tooltip);
        }

        const dayLabel = document.createElement("div");
        dayLabel.textContent = day;
        cell.appendChild(dayLabel);

        if (!occupatoDa) {
          const price = document.createElement("div");
          const mese = monthNames[currentMonth].toLowerCase();
          price.className = "price";
          price.textContent = prezzi[mese]?.notte + "‚Ç¨";
          cell.appendChild(price);
        }

        daysGrid.appendChild(cell);
      }

      container.appendChild(daysGrid);
    }

    function prevMonth() {
      if (currentMonth === 0) {
        currentMonth = 11;
        currentYear--;
      } else {
        currentMonth--;
      }
      updateCalendar();
    }

    function nextMonth() {
      if (currentMonth === 11) {
        currentMonth = 0;
        currentYear++;
      } else {
        currentMonth++;
      }
      updateCalendar();
    }

    function goToToday() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      updateCalendar();
    }

    function updateCalendar() {
      fetchData().then(data => {
        buildCalendar(data.prenotazioni, data.prezzi);
      });
    }

    goToToday();
  </script>
</body>
</html>
