// Google Apps Script: Estrazione prenotazioni da foglio con parsing formato 'dom 20 apr 25'
function doGet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Prenotazioni ALBA");
  const data = sheet.getDataRange().getValues();

  const today = new Date();
  const prenotazioni = [];

  // Mappa mesi italiani
  const mesi = {
    "gen": 0, "feb": 1, "mar": 2, "apr": 3, "mag": 4, "giu": 5,
    "lug": 6, "ago": 7, "set": 8, "ott": 9, "nov": 10, "dic": 11
  };

  for (let i = 1; i < data.length; i++) {
    const cliente = data[i][0];
    const inizioRaw = data[i][1];
    const fineRaw = data[i][2];

    if (!inizioRaw || !fineRaw) continue;

    try {
      // Parsing tipo 'dom 20 apr 25'
      const [,, giornoInizio, meseInizio, annoInizio] = inizioRaw.split(" ");
      const [,, giornoFine, meseFine, annoFine] = fineRaw.split(" ");

      const inizio = new Date(parseInt("20" + annoInizio), mesi[meseInizio], parseInt(giornoInizio));
      const fine = new Date(parseInt("20" + annoFine), mesi[meseFine], parseInt(giornoFine));

      if (!isNaN(inizio) && !isNaN(fine)) {
        prenotazioni.push(`PRENOTAZIONE: ${cliente} dal ${inizio.toLocaleDateString()} al ${fine.toLocaleDateString()}`);
      }
    } catch (e) {
      Logger.log("Errore parsing riga " + (i+1) + ": " + e);
    }
  }

  const output = prenotazioni.length > 0
    ? `<ul>` + prenotazioni.map(p => `<li>${p}</li>`).join("") + `</ul>`
    : "<p>Nessuna prenotazione trovata.</p>";

  const html = `
    <html><head>
      <style>
        body { font-family: Arial; background: #f1f1f1; text-align: center; padding: 50px; }
        .box { background: #fff; padding: 20px; border-radius: 8px; display: inline-block; }
        ul { text-align: left; }
      </style>
    </head><body>
      <div class="box">
        <h2>Verifica Prenotazioni dal Foglio</h2>
        ${output}
      </div>
    </body></html>`;

  return ContentService.createTextOutput(html).setMimeType(ContentService.MimeType.HTML);
}
