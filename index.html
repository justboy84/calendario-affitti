<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Affitti 2025</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1, h2 { text-align: center; }
    .month-block { margin: 30px auto; max-width: 800px; }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc;
      width: 14.28%;
      height: 90px;
      vertical-align: top;
      padding: 6px;
      position: relative;
    }
    td.occupied { background-color: #ffd6d6; }
    td.free { background-color: #eaffea; }
    .day-number { font-weight: bold; }
    .price { font-size: 0.75em; color: #007b00; position: absolute; bottom: 4px; right: 6px; }
  </style>
</head>
<body>
  <h1>Calendario Affitti 2025</h1>
  <div id="calendar">Caricamento calendario...</div>

  <script>
    async function loadCalendar() {
      const response = await fetch("https://script.google.com/macros/s/AKfycbxfJ3pJHkSm0SHenFspLTkVrUOO_Ts0XJ4ZLcSE4EYg8qXKG8oQpa94Gi0sR28-WV74GQ/exec?function=doGetData");
      const data = await response.json();

      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";

      const prenotazioni = data.prenotazioni.map(p => ({
        start: new Date(p.start),
        end: new Date(p.end)
      }));

      const months = [
        "Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
        "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"
      ];

      for (let m = 0; m < 12; m++) {
        const monthDiv = document.createElement("div");
        monthDiv.className = "month-block";

        const header = document.createElement("h2");
        header.textContent = `${months[m]} 2025`;
        monthDiv.appendChild(header);

        const table = document.createElement("table");
        const weekHeader = document.createElement("tr");
        ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"].forEach(day => {
          const th = document.createElement("th");
          th.textContent = day;
          weekHeader.appendChild(th);
        });
        table.appendChild(weekHeader);

        let date = new Date(2025, m, 1);
        const firstDay = (date.getDay() + 6) % 7;
        let row = document.createElement("tr");

        for (let i = 0; i < firstDay; i++) {
          row.appendChild(document.createElement("td"));
        }

        while (date.getMonth() === m) {
          const cell = document.createElement("td");
          const iso = date.toISOString().split('T')[0];
          const giorno = date.getDate();
          const giornoSettimana = date.getDay();
          const mese = date.toLocaleDateString("it-IT", { month: 'long' }).toLowerCase();

          const dateOnly = date.toISOString().split('T')[0];
const occupied = prenotazioni.some(p => {
  const s = p.start.toISOString().split('T')[0];
  const e = p.end.toISOString().split('T')[0];
  return dateOnly >= s && dateOnly < e;
});
          cell.className = occupied ? "occupied" : "free";
          cell.innerHTML = `<div class='day-number'>${giorno}</div>`;

          if (!occupied) {
            let prezzo = parseFloat(data.prezzi[mese]?.notte || 0);
            if (giornoSettimana === 5 || giornoSettimana === 6) {
              prezzo += parseFloat(data.prezzi[mese]?.weekend || 0);
            }
            cell.innerHTML += `<div class='price'>â‚¬ ${prezzo.toFixed(0)}</div>`;
          }

          row.appendChild(cell);

          if ((firstDay + giorno) % 7 === 0) {
            table.appendChild(row);
            row = document.createElement("tr");
          }

          date.setDate(date.getDate() + 1);
        }

        if (row.children.length > 0) {
          while (row.children.length < 7) {
            row.appendChild(document.createElement("td"));
          }
          table.appendChild(row);
        }

        monthDiv.appendChild(table);
        calendar.appendChild(monthDiv);
      }
    }

    loadCalendar();
  </script>
</body>
</html>
