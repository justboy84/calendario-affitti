<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Calendario Affitti</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    h1 { text-align: center; margin-bottom: 30px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; margin: 0 auto; background: white; }
    td, th { border: 1px solid #ccc; text-align: center; vertical-align: top; padding: 10px; position: relative; height: 80px; }
    .occupied { background: #ffb3b3; } /* rosso */
    .available { background: #d4f8d4; } /* verde */
    .price { position: absolute; bottom: 5px; right: 5px; font-size: 0.75em; color: #444; }
  </style>
</head>
<body>

<h1>Calendario Prenotazioni Affitti</h1>

<div id="calendar"></div>

<script>
  const sheetId = "1HJ9pL9kPc3As9XazbdUvQpzgBPxYXbWdj2FR-MxJJgc"; // <-- il tuo ID
  const sheetName = "Prenotazioni ALBA"; // Nome del foglio
  const prezziSheetName = "Prezzi ALBA";

  const currentYear = 2025;

  async function fetchSheet(sheetName) {
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    return json.table.rows.map(r => r.c.map(c => c?.v));
  }

  function buildCalendar(dates, prices) {
    const calendar = document.getElementById("calendar");
    const months = [
      "Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
      "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"
    ];

    for (let m = 0; m < 12; m++) {
      const table = document.createElement("table");
      const header = document.createElement("tr");
      header.innerHTML = `<th colspan="7">${months[m]}</th>`;
      table.appendChild(header);

      const weekDays = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];
      const daysRow = document.createElement("tr");
      for (let d of weekDays) {
        daysRow.innerHTML += `<th>${d}</th>`;
      }
      table.appendChild(daysRow);

      let date = new Date(currentYear, m, 1);
      const firstDay = (date.getDay() + 6) % 7; // lunedì = 0

      let row = document.createElement("tr");
      for (let i = 0; i < firstDay; i++) {
        row.innerHTML += "<td></td>";
      }

      while (date.getMonth() === m) {
        const day = date.getDate();
        const isoDate = date.toISOString().split("T")[0];

        const isOccupied = dates.some(([_, start, end]) => {
          const s = new Date(start);
          const e = new Date(end);
          return date >= s && date < e;
        });

        const priceRow = prices.find(r => r[0]?.toLowerCase().includes(months[m].toLowerCase()));
        const dailyPrice = priceRow ? priceRow[4] : "€";

        row.innerHTML += `
          <td class="${isOccupied ? "occupied" : "available"}">
            ${day}
            <div class="price">${isOccupied ? "" : dailyPrice}</div>
          </td>
        `;

        if ((firstDay + day) % 7 === 0) {
          table.appendChild(row);
          row = document.createElement("tr");
        }

        date.setDate(day + 1);
      }

      if (row.innerHTML !== "") table.appendChild(row);

      calendar.appendChild(table);
      calendar.appendChild(document.createElement("br"));
    }
  }

  async function main() {
    const bookings = await fetchSheet(sheetName);       // Prenotazioni
    const prices = await fetchSheet(prezziSheetName);   // Prezzi mensili
    buildCalendar(bookings.slice(1), prices.slice(1));
  }

  main();
</script>

</body>
</html>
